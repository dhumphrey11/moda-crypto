rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.admin == true || 
              request.auth.uid in ['admin-user-uid-1', 'admin-user-uid-2']); // Add your admin UIDs here
    }
    
    function isSystemUser() {
      return isAuthenticated() && 
             request.auth.token.system == true;
    }
    
    // DEVELOPMENT RULES - More permissive for authenticated users
    
    // Signals collection - read for all authenticated users
    match /signals/{signalId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Allow writes for development
    }
    
    // Portfolio collection - allow authenticated users to access their own data
    match /portfolio/{document=**} {
      allow read, write: if isAuthenticated();
    }
    
    // System health - read for authenticated users  
    match /system_health/{healthId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Allow writes for development
    }
    
    // User profiles - user-specific access
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Trades collection - allow authenticated users
    match /trades/{document=**} {
      allow read, write: if isAuthenticated();
    }
    
    // Admin configuration - admin only (but also allow read for authenticated users in dev)
    match /admin_config/{configId} {
      allow read: if isAuthenticated(); // Dev: allow read for all authenticated
      allow write: if isAdmin();
    }
    
    // Model information - read for authenticated users
    match /models/{modelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Dev: allow writes
    }
    
    // Tokens collection - read for all authenticated users
    match /tokens/{tokenId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Dev: allow writes
    }
    
    // API keys and sensitive data - admin only
    match /api_keys/{keyId} {
      allow read, write: if isAdmin();
    }
    
    // Audit logs - allow authenticated users to read in dev
    match /audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Notifications - allow authenticated users
    match /notifications/{document=**} {
      allow read, write: if isAuthenticated();
    }
    
    // Allow all authenticated users to access most collections for development
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}